<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Captura de fotos - Active Server">
    <meta name="theme-color" content="#4f46e5">
    <title>Cámara - Active Server</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }

        #video,
        #canvas {
            width: 100%;
            height: auto;
            display: block;
        }

        #canvas {
            display: none;
        }

        .camera-controls {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .camera-controls button {
            flex: 1;
            min-width: 120px;
        }

        .capture-btn {
            background: var(--success) !important;
            position: relative;
        }

        .capture-btn:hover {
            background: #059669 !important;
        }

        .preview-container {
            margin-top: 20px;
            display: none;
        }

        .preview-image {
            width: 100%;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
        }

        .gallery-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            color: white;
            padding: 8px;
            font-size: 11px;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            text-align: center;
            font-weight: 600;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
        }

        @media (max-width: 480px) {
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="card">
        <a href="home.html">← Volver al inicio</a>
        <h2>Captura de Fotos</h2>

        <div id="status-message"></div>

        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

        <div class="camera-controls">
            <button class="btn-blue" id="btn-start">Iniciar Cámara</button>
            <button class="btn-blue capture-btn" id="btn-capture" disabled>Capturar Foto</button>
            <button class="btn-red" id="btn-stop" disabled>Detener Cámara</button>
        </div>

        <div class="preview-container" id="preview-container">
            <h3>Vista Previa</h3>
            <img id="preview-image" class="preview-image" alt="Preview">
            <div class="camera-controls">
                <button class="btn-blue" id="btn-upload">Subir Foto</button>
                <button class="btn-red" id="btn-discard">Descartar</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Galería de Fotos</h3>
        <div class="gallery-grid" id="gallery"></div>
    </div>

    <script type="module">
        import { auth, db, ref, onValue, push, remove } from './firebase-config.js';
        import { getStorage, ref as storageRef, uploadString, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const btnStart = document.getElementById('btn-start');
        const btnCapture = document.getElementById('btn-capture');
        const btnStop = document.getElementById('btn-stop');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        const btnUpload = document.getElementById('btn-upload');
        const btnDiscard = document.getElementById('btn-discard');
        const gallery = document.getElementById('gallery');
        const statusMessage = document.getElementById('status-message');

        const storage = getStorage();
        let stream = null;
        let currentUserId = null;
        let capturedImageData = null;

        // Check authentication
        auth.onAuthStateChanged(user => {
            if (!user) {
                location.href = 'index.html';
                return;
            }
            currentUserId = user.uid;
            loadGallery();
        });

        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.className = `status-message status-${type}`;
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 3000);
            }
        }

        // Start camera
        btnStart.onclick = async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                video.srcObject = stream;
                btnStart.disabled = true;
                btnCapture.disabled = false;
                btnStop.disabled = false;
                showStatus('Cámara iniciada correctamente', 'success');
            } catch (err) {
                console.error('Error accessing camera:', err);
                showStatus('Error al acceder a la cámara: ' + err.message, 'error');
            }
        };

        // Capture photo
        btnCapture.onclick = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            previewImage.src = capturedImageData;
            previewContainer.style.display = 'block';
            showStatus('Foto capturada. Revisa la vista previa.', 'success');
        };

        // Stop camera
        btnStop.onclick = () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                btnStart.disabled = false;
                btnCapture.disabled = true;
                btnStop.disabled = true;
                showStatus('Cámara detenida', 'info');
            }
        };

        // Upload photo
        btnUpload.onclick = async () => {
            if (!capturedImageData) return;

            btnUpload.disabled = true;
            btnUpload.textContent = 'Subiendo...';
            showStatus('Subiendo foto a Firebase...', 'info');

            try {
                const timestamp = Date.now();
                const fileName = `photos/${currentUserId}/${timestamp}.jpg`;
                const photoRef = storageRef(storage, fileName);

                // Upload image
                await uploadString(photoRef, capturedImageData, 'data_url');
                const downloadURL = await getDownloadURL(photoRef);

                // Save metadata to database
                await push(ref(db, `fotos/${currentUserId}`), {
                    url: downloadURL,
                    fileName: fileName,
                    fecha: new Date().toLocaleString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    timestamp: timestamp
                });

                showStatus('Foto subida correctamente', 'success');
                previewContainer.style.display = 'none';
                capturedImageData = null;
                btnUpload.disabled = false;
                btnUpload.textContent = 'Subir Foto';
            } catch (err) {
                console.error('Error uploading photo:', err);
                showStatus('Error al subir la foto: ' + err.message, 'error');
                btnUpload.disabled = false;
                btnUpload.textContent = 'Subir Foto';
            }
        };

        // Discard photo
        btnDiscard.onclick = () => {
            previewContainer.style.display = 'none';
            capturedImageData = null;
            showStatus('Foto descartada', 'info');
        };

        // Load gallery
        function loadGallery() {
            const photosRef = ref(db, `fotos/${currentUserId}`);
            onValue(photosRef, (snap) => {
                gallery.innerHTML = '';

                if (!snap.exists()) {
                    gallery.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#94a3b8; padding:24px;">No hay fotos capturadas aún</p>';
                    return;
                }

                const photos = [];
                snap.forEach(child => {
                    photos.push({ key: child.key, ...child.val() });
                });

                // Sort by timestamp (newest first)
                photos.sort((a, b) => b.timestamp - a.timestamp);

                photos.forEach(photo => {
                    const item = document.createElement('div');
                    item.className = 'gallery-item';
                    item.innerHTML = `
                        <img src="${photo.url}" alt="Foto ${photo.fecha}">
                        <div class="gallery-item-info">
                            ${photo.fecha}
                        </div>
                    `;

                    item.onclick = () => {
                        if (confirm('¿Deseas eliminar esta foto?')) {
                            deletePhoto(photo.key, photo.fileName);
                        }
                    };

                    gallery.appendChild(item);
                });
            });
        }

        // Delete photo
        async function deletePhoto(photoKey, fileName) {
            try {
                showStatus('Eliminando foto...', 'info');

                // Delete from storage
                const photoRef = storageRef(storage, fileName);
                await deleteObject(photoRef);

                // Delete from database
                await remove(ref(db, `fotos/${currentUserId}/${photoKey}`));

                showStatus('Foto eliminada correctamente', 'success');
            } catch (err) {
                console.error('Error deleting photo:', err);
                showStatus('Error al eliminar la foto: ' + err.message, 'error');
            }
        }

        // Stop camera when leaving page
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>

</html>