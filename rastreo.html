<link rel="stylesheet" href="style.css">
<div class="card">
    <a href="home.html">← Volver</a>
    <h2>Rastreador</h2>
    <div style="background:#eee; padding:10px; border-radius:5px; margin:10px 0;">
        <code id="myLink">Generando...</code>
    </div>
    <button class="btn-blue" id="btn-copy">Copiar Link</button>
    <button class="btn-red" id="btn-del">Limpiar Datos</button>
</div>

<div class="card">
    <table>
        <thead><tr><th>IP</th><th>Ciudad</th><th>Fecha</th></tr></thead>
        <tbody id="list"></tbody>
    </table>
</div>

<script type="module">
    import { auth, db, ref, onValue, remove } from './firebase-config.js';

    // Capturamos los elementos correctamente
    const txtLink = document.getElementById('myLink');
    const tableList = document.getElementById('list');
    const btnCopy = document.getElementById('btn-copy');
    const btnDelete = document.getElementById('btn-del');

    auth.onAuthStateChanged(u => {
        if(!u) {
            location.href = 'index.html';
            return;
        }

        // 1. Generar Link
        const link = `${window.location.origin}/view.html?id=${u.uid}`;
        txtLink.innerText = link;

        // 2. Escuchar Visitas
        const visitasRef = ref(db, `visitas/${u.uid}`);
        onValue(visitasRef, (snap) => {
            tableList.innerHTML = "";
            if (!snap.exists()) {
                tableList.innerHTML = "<tr><td colspan='3' style='text-align:center'>Sin visitas</td></tr>";
                return;
            }
            
            snap.forEach(child => {
                const v = child.val();
                const row = `<tr>
                    <td>${v.ip}</td>
                    <td>${v.ciudad}</td>
                    <td>${v.fecha}</td>
                </tr>`;
                tableList.innerHTML = row + tableList.innerHTML; // Lo más nuevo arriba
            });
        });

        // 3. Configurar Botones (Sin errores de asignación)
        btnCopy.onclick = () => {
            navigator.clipboard.writeText(link);
            alert("¡Link copiado!");
        };

        btnDelete.onclick = async () => {
            if(confirm("¿Seguro que quieres borrar todo?")) {
                await remove(visitasRef);
            }
        };
    });
</script>