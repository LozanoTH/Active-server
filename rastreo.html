<link rel="stylesheet" href="style.css">
<div class="card">
    <a href="home.html">← Volver</a>
    <h2>Rastreador</h2>
    <div style="background:#eee; padding:10px; border-radius:5px; margin:10px 0;">
        <code id="myLink">Generando...</code>
    </div>
    <button class="btn-blue" id="btn-copy">Copiar Link</button>
    <button class="btn-red" id="btn-del">Limpiar Datos</button>
</div>

<div class="card">
    <table>
        <thead><tr><th>IP</th><th>Ciudad</th><th>Fecha</th></tr></thead>
        <tbody id="list"></tbody>
    </table>
</div>

<script type="module">
    import { auth, db, ref, onValue, remove } from './firebase-config.js';
    auth.onAuthStateChanged(u => {
        if(!u) return;
        const link = `${location.origin}/view.html?id=${u.uid}`;
        myLink.innerText = link;

        onValue(ref(db, `visitas/${u.uid}`), snap => {
            list.innerHTML = "";
            snap.forEach(child => {
                const v = child.val();
                list.innerHTML = `<tr><td>${v.ip}</td><td>${v.ciudad}</td><td>${v.fecha}</td></tr>` + list.innerHTML;
            });
        });

        btn-del.onclick = () => confirm("¿Borrar?") && remove(ref(db, `visitas/${u.uid}`));
        btn-copy.onclick = () => { navigator.clipboard.writeText(link); alert("Copiado"); };
    });
</script>